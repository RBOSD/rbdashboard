<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éµé“äº‹æ•…(ä»¶)å‹•æ…‹ç›£ç†çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; color: #333; }
        h1 { text-align: center; color: #00508F; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #5f6368; margin-bottom: 20px; font-weight: bold; }
        .control-panel { background: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; border-left: 5px solid #00508F; }
        select { padding: 8px 12px; font-size: 15px; border: 1px solid #ccd0d5; border-radius: 6px; outline: none; background-color: #f8f9fa; cursor: pointer; }
        select:hover { border-color: #00508F; }
        .dashboard-grid-top { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .dashboard-grid-bottom { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
        .chart-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; height: 320px; }
        .tall-container { height: 500px; }
        .breadcrumb { font-size: 14px; color: #00508F; margin-bottom: 10px; font-weight: bold; background: #e8f0fe; padding: 10px 15px; border-radius: 6px; border: 1px solid #d2e3fc;}
        .drill-btn { background-color: #424242; color: white; cursor: pointer; border: none; font-weight: bold; padding: 6px 12px; border-radius: 6px; transition: background 0.2s;}
        .drill-btn:hover { background-color: #212121; }
        .reset-btn { background-color: #fff; color: #00508F; border: 2px solid #00508F; font-weight: bold; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 14px;}
        .reset-btn:hover { background-color: #e8f0fe; }
        .summary-text { font-size: 15px; color: #3c4043; margin-left: auto; font-weight: bold; background: #fef7e0; padding: 8px 15px; border-radius: 6px; border: 1px solid #fce8b2;}
        .hint { font-size: 12px; color: #888; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

    <h1>ğŸš† éµé“äº‹æ•…(ä»¶)å‹•æ…‹ç›£ç†çœ‹æ¿</h1>
    <div class="subtitle"></div>

    <div class="control-panel">
        <label><strong>ç‡Ÿé‹æ©Ÿæ§‹ï¼š</strong>
            <select id="operatorFilter" onchange="updateAllCharts()">
                <option value="all">å…¨æ©Ÿæ§‹ (è‡º/é«˜/æ—/ç³–)</option>
                <option value="è‡ºéµ">è‡ºéµ</option>
                <option value="é«˜éµ">é«˜éµ</option>
                <option value="æ—éµ">æ—éµ</option>
                <option value="ç³–éµ">ç³–éµ</option>
            </select>
        </label>
        
        <label><strong>æ™‚é–“å‘ˆç¾ï¼š</strong>
            <select id="timeAggFilter" onchange="updateAllCharts()">
                <option value="month">ä»¥æœˆç‚ºå–®ä½</option>
                <option value="quarter">ä»¥å­£ç‚ºå–®ä½</option>
            </select>
        </label>

        <label><strong>ç‰¹å®šå€é–“ï¼š</strong>
            <select id="monthFilter" onchange="updateAllCharts()">
                <option value="all">å…¨å€é–“</option>
                <option value="114/08">114å¹´08æœˆ</option>
                <option value="114/09">114å¹´09æœˆ</option>
                <option value="114/10">114å¹´10æœˆ</option>
                <option value="114/11">114å¹´11æœˆ</option>
                <option value="114/12">114å¹´12æœˆ</option>
                <option value="115/01">115å¹´01æœˆ</option>
                <option value="115/02">115å¹´02æœˆ</option>
            </select>
        </label>
        
        <label><strong>äº‹æ•…(ä»¶)åˆ†é¡ï¼š</strong>
            <select id="classFilter" onchange="updateAllCharts()">
                <option value="all">å…¨éƒ¨åˆ†é¡</option>
                <option value="é‡å¤§è¡Œè»Šäº‹æ•…">é‡å¤§è¡Œè»Šäº‹æ•…</option>
                <option value="ä¸€èˆ¬è¡Œè»Šäº‹æ•…">ä¸€èˆ¬è¡Œè»Šäº‹æ•…</option>
                <option value="ç•°å¸¸äº‹ä»¶">ç•°å¸¸äº‹ä»¶</option>
            </select>
        </label>
        
        <button class="reset-btn" onclick="resetDashboard()">ğŸ”„ åœ–è¡¨Reset</button>

        <div class="summary-text" id="dataSummary">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>

    <div class="dashboard-grid-top">
        <div class="chart-container"><canvas id="trendChart"></canvas></div>
        <div class="chart-container"><canvas id="operatorPieChart"></canvas></div>
        <div class="chart-container"><canvas id="classPieChart"></canvas></div>
    </div>

    <div class="dashboard-grid-bottom">
        <div class="chart-container tall-container">
            <div class="breadcrumb" style="background:#fce8e6; color:#c5221f; border-color:#fad2cf;">
                ğŸ“Œ äº‹æ•…(ä»¶)ç¨®é¡
            </div>
            <canvas id="typeChart"></canvas>
            <div class="hint">ğŸ’¡ é»é¸ä»¥éæ¿¾çœ‹æ¿ï¼Œæœªé¸é …ç›®å°‡è‡ªå‹•åç°</div>
        </div>

        <div class="chart-container tall-container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div id="causeBreadcrumb" class="breadcrumb">
                    ğŸ” 2. è‚‡å› é‘½ç ”ï¼šç›®å‰æª¢è¦–ã€ŒåŸå› ä¸€éšã€
                </div>
                <button id="btnBack" class="drill-btn" onclick="goBackLevel()" style="display:none;">â¤´ è¿”å›ä¸Šä¸€å±¤</button>
            </div>
            <canvas id="causeChart"></canvas>
            <div class="hint">ğŸ’¡ é»é¸é•·æ¢åœ–å‘ä¸‹é‘½ç ”ï¼Œä¸‰éšå¯é–å®šåˆ†æ</div>
        </div>
    </div>

    <script>
        const operators = ['è‡ºéµ', 'é«˜éµ', 'æ—éµ', 'ç³–éµ'];
        const months = ['114/08', '114/09', '114/10', '114/11', '114/12', '115/01', '115/02'];
        const quarters = ['114å¹´ Q3', '114å¹´ Q4', '115å¹´ Q1'];
        
        const monthToQuarter = {
            '114/08': '114å¹´ Q3', '114/09': '114å¹´ Q3',
            '114/10': '114å¹´ Q4', '114/11': '114å¹´ Q4', '114/12': '114å¹´ Q4',
            '115/01': '115å¹´ Q1', '115/02': '115å¹´ Q1'
        };

        const OPERATOR_COLORS = { 
            'è‡ºéµ': '#00508F', 'é«˜éµ': '#EA5C04', 'æ—éµ': '#276E46', 'ç³–éµ': '#8DA845' 
        };
        const CLASS_COLORS = { 
            'é‡å¤§è¡Œè»Šäº‹æ•…': '#ea4335', 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…': '#f29900', 'ç•°å¸¸äº‹ä»¶': '#90A4AE' 
        };
        
        const DEPTH_COLORS = {
            1: '#424242', 
            2: '#757575', 
            3: '#BDBDBD'  
        };
        const FOCUS_COLOR = '#00897B'; 
        const FADE_COLOR = '#EEEEEE';  
        
        const causeTemplates = [
            // 1.éµè·¯è¨­å‚™åŠŸèƒ½ç•°å¸¸
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'åˆ—è»Šæˆ–è»Šè¼›æ•…éšœ', l1: '1.éµè·¯è¨­å‚™åŠŸèƒ½ç•°å¸¸', l2: '1.01è»Šè¼›è¨­å‚™åŠŸèƒ½ç•°å¸¸', l3: '1.01.01å‹•åŠ›ç³»çµ±ç•°å¸¸' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'åˆ—è»Šæˆ–è»Šè¼›æ•…éšœ', l1: '1.éµè·¯è¨­å‚™åŠŸèƒ½ç•°å¸¸', l2: '1.01è»Šè¼›è¨­å‚™åŠŸèƒ½ç•°å¸¸', l3: '1.01.03æ©Ÿ(è‡ºéµã€æ—éµã€ç³–éµ)/ç…è»Š(é«˜éµ)ç³»çµ±ç•°å¸¸' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'åˆ—è»Šæˆ–è»Šè¼›æ•…éšœ', l1: '1.éµè·¯è¨­å‚™åŠŸèƒ½ç•°å¸¸', l2: '1.01è»Šè¼›è¨­å‚™åŠŸèƒ½ç•°å¸¸', l3: '1.01.10ATPè»Šä¸Šè¨­å‚™ç•°å¸¸(è‡ºéµ)' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'é‹è½‰ä¿å®‰è£ç½®æ•…éšœ', l1: '1.éµè·¯è¨­å‚™åŠŸèƒ½ç•°å¸¸', l2: '1.02é‹è½‰ä¿å®‰è£ç½®åŠŸèƒ½ç•°å¸¸', l3: '1.02.01è½‰è½å™¨/é“å²”å®šä½ç•°å¸¸' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'é‹è½‰ä¿å®‰è£ç½®æ•…éšœ', l1: '1.éµè·¯è¨­å‚™åŠŸèƒ½ç•°å¸¸', l2: '1.02é‹è½‰ä¿å®‰è£ç½®åŠŸèƒ½ç•°å¸¸', l3: '1.02.06è¨ˆè»¸å™¨ç•°å¸¸' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'é›»åŠ›è¨­å‚™æ•…éšœ', l1: '1.éµè·¯è¨­å‚™åŠŸèƒ½ç•°å¸¸', l2: '1.03é›»åŠ›è¨­å‚™åŠŸèƒ½ç•°å¸¸', l3: '1.03.01è®Šé›»ç«™ç•°å¸¸' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'é›»åŠ›è¨­å‚™æ•…éšœ', l1: '1.éµè·¯è¨­å‚™åŠŸèƒ½ç•°å¸¸', l2: '1.03é›»åŠ›è¨­å‚™åŠŸèƒ½ç•°å¸¸', l3: '1.03.07æ¶ç·šè£ç½®ç•°å¸¸' },
            { class: 'é‡å¤§è¡Œè»Šäº‹æ•…', type: 'æ­£ç·šå‡ºè»Œäº‹æ•…', l1: '1.éµè·¯è¨­å‚™åŠŸèƒ½ç•°å¸¸', l2: '1.04è»Œé“è¨­å‚™/åœŸæœ¨çµæ§‹ç•°å¸¸', l3: '1.04.01é‹¼è»Œæ–·è£‚' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'è·¯ç·šéšœç¤™', l1: '1.éµè·¯è¨­å‚™åŠŸèƒ½ç•°å¸¸', l2: '1.04è»Œé“è¨­å‚™/åœŸæœ¨çµæ§‹ç•°å¸¸', l3: '1.04.04é‚Šå¡æ»‘å‹•' },
            { class: 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…', type: 'è¨­å‚™æå®³äº‹æ•…', l1: '1.éµè·¯è¨­å‚™åŠŸèƒ½ç•°å¸¸', l2: '1.05å…¶ä»–è¨­å‚™åŠŸèƒ½ç•°å¸¸', l3: '1.05.01å ´ç«™è¨­æ–½æå£' },

            // 2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ 
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'é•åè™ŸèªŒé‹è½‰', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.01éµè·¯å“¡å·¥ç–å¤±', l3: '2.01.09æœªç¢ºèªè™ŸèªŒã€è™Ÿè¨Šã€æ¨™èªŒ' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'é€²å…¥éŒ¯ç·š', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.01éµè·¯å“¡å·¥ç–å¤±', l3: '2.01.08æœªç¢ºèªè½‰è½å™¨é–‹é€šæ–¹ä½' },
            { class: 'é‡å¤§è¡Œè»Šäº‹æ•…', type: 'æ­£ç·šè¡æ’äº‹æ•…', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.01éµè·¯å“¡å·¥ç–å¤±', l3: '2.01.11æœªéµå®ˆç¨‹åºæ“ä½œåˆ—è»Šæˆ–è»Šè¼›' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'é›»åŠ›è¨­å‚™æ•…éšœ', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.01éµè·¯å“¡å·¥ç–å¤±', l3: '2.01.12æœªéµå®ˆç¨‹åºæ“ä½œé›»åŠ›è¨­å‚™' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'åˆ—è»Šæˆ–è»Šè¼›æ•…éšœ', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.01éµè·¯å“¡å·¥ç–å¤±', l3: '2.01.14ä¸Šè»Šå‰æœªæ ¸å°ATPåˆ—è»Šè³‡è¨Š' },
            { class: 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…', type: 'è¡æ’äº‹æ•…', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.01éµè·¯å“¡å·¥ç–å¤±', l3: '2.01.16èº«é«”ä¸é©' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'å…¶ä»–äº‹ä»¶', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.01éµè·¯å“¡å·¥ç–å¤±', l3: '2.01.15äººå“¡è¯ç¹«ä¸ç•¶è‡´ä½œæ¥­å¤±èª¤' },
            { class: 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…', type: 'å‡ºè»Œäº‹æ•…', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.02éµè·¯æ©Ÿæ§‹æ‰¿åŒ…å•†ç–å¤±', l3: '2.02.01ä¾µå…¥è·¯ç·šæ·¨ç©º' },
            { class: 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…', type: 'å‡ºè»Œäº‹æ•…', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.02éµè·¯æ©Ÿæ§‹æ‰¿åŒ…å•†ç–å¤±', l3: '2.02.02æ–½å·¥ä¸ç•¶' },
            { class: 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…', type: 'é‹è½‰ä¸­æ–·äº‹æ•…', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.02éµè·¯æ©Ÿæ§‹æ‰¿åŒ…å•†ç–å¤±', l3: '2.02.03äººå“¡è¯ç¹«ä¸ç•¶è‡´ä½œæ¥­å¤±èª¤' },
            { class: 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…', type: 'å‡ºè»Œäº‹æ•…', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.03éµé“å±€æ–½å·¥ç–å¤±', l3: '2.03.01ä¾µå…¥è·¯ç·šæ·¨ç©º' },
            { class: 'é‡å¤§è¡Œè»Šäº‹æ•…', type: 'æ­£ç·šå‡ºè»Œäº‹æ•…', l1: '2.å“¡å·¥èˆ‡æ‰¿å•†å› ç´ ', l2: '2.03éµé“å±€æ–½å·¥ç–å¤±', l3: '2.03.02æ–½å·¥ä¸ç•¶' },

            // 3.æ°‘çœ¾èˆ‡æ—…å®¢å› ç´ 
            { class: 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…', type: 'å¹³äº¤é“äº‹æ•…', l1: '3.æ°‘çœ¾èˆ‡æ—…å®¢å› ç´ ', l2: '3.02æ°‘çœ¾/æ±½æ©Ÿè»Šé—–å…¥ç«™é–“è»Œé“', l3: '3.02.01æ°‘çœ¾/æ±½æ©Ÿè»Šé—–å…¥ç«™é–“è»Œé“' },
            { class: 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…', type: 'æ­»å‚·äº‹æ•…', l1: '3.æ°‘çœ¾èˆ‡æ—…å®¢å› ç´ ', l2: '3.03æ—…å®¢é—–å…¥/è·Œè½æœˆå°è»Œé“', l3: '3.03.01æ—…å®¢é—–å…¥/è·Œè½æœˆå°è»Œé“' },

            // 4.å¤–ç‰©å› ç´ 
            { class: 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…', type: 'è¨­å‚™æå®³äº‹æ•…', l1: '4.å¤–ç‰©å› ç´ ', l2: '4.01å‹•ç‰©å…¥ä¾µè·¯ç·š', l3: '4.01.01å‹•ç‰©å…¥ä¾µè·¯ç·š' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'å¤–ç‰©å…¥ä¾µ', l1: '4.å¤–ç‰©å› ç´ ', l2: '4.01å‹•ç‰©å…¥ä¾µè·¯ç·š', l3: '4.01.01å‹•ç‰©å…¥ä¾µè·¯ç·š' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'è·¯ç·šéšœç¤™', l1: '4.å¤–ç‰©å› ç´ ', l2: '4.02æ¨¹æœ¨æè‘‰/åœŸçŸ³å…¥ä¾µè·¯ç·š', l3: '4.02.01æ¨¹æœ¨æè‘‰/åœŸçŸ³å…¥ä¾µè·¯ç·š' },

            // 5.å¤©ç„¶å› ç´ 
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'å¤©ç„¶ç½è®Š', l1: '5.å¤©ç„¶å› ç´ ', l2: '5.01è±ªå¤§é›¨', l3: '5.01.01è±ªå¤§é›¨' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'å¤©ç„¶ç½è®Š', l1: '5.å¤©ç„¶å› ç´ ', l2: '5.02åœ°éœ‡', l3: '5.02.01åœ°éœ‡' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'å¤©ç„¶ç½è®Š', l1: '5.å¤©ç„¶å› ç´ ', l2: '5.03é¢±é¢¨/å¼·é¢¨', l3: '5.03.01é¢±é¢¨/å¼·é¢¨' },
            { class: 'ç•°å¸¸äº‹ä»¶', type: 'å¤©ç„¶ç½è®Š', l1: '5.å¤©ç„¶å› ç´ ', l2: '5.08å°é›»ä¾›é›»ç•°å¸¸', l3: '5.08.01å°é›»ä¾›é›»ç•°å¸¸' }
        ];

        const typeToClassMap = {};
        causeTemplates.forEach(t => {
            typeToClassMap[t.type] = t.class;
        });

        let rawData = [];
        for (let i = 0; i < 5000; i++) {
            let opRand = Math.random();
            let selectedOp = opRand < 0.75 ? 'è‡ºéµ' : (opRand < 0.90 ? 'é«˜éµ' : (opRand < 0.97 ? 'æ—éµ' : 'ç³–éµ'));
            let selectedTemplate = causeTemplates[Math.floor(Math.random() * causeTemplates.length)];
            let m = months[Math.floor(Math.random() * months.length)];
            let randomCount = Math.floor(Math.random() * 10) < 9 ? 1 : 2;

            rawData.push({
                operator: selectedOp,
                month: m,
                quarter: monthToQuarter[m],
                class: selectedTemplate.class,
                type: selectedTemplate.type,
                l1: selectedTemplate.l1,
                l2: selectedTemplate.l2,
                l3: selectedTemplate.l3,
                count: randomCount
            });
        }

        let trendChart, operatorPieChart, classPieChart, typeChart, causeChart;
        let selectedTypeFilter = null; 
        let currentDrillLevel = 1; 
        let selectedL1 = null, selectedL2 = null, selectedL3 = null; 

        window.onload = function() { initCharts(); updateAllCharts(); };

        function getBaseData() {
            const opFilter = document.getElementById('operatorFilter').value;
            const mFilter = document.getElementById('monthFilter').value;
            const cFilter = document.getElementById('classFilter').value;
            
            return rawData.filter(d => 
                (opFilter === 'all' || d.operator === opFilter) &&
                (mFilter === 'all' || d.month === mFilter) &&
                (cFilter === 'all' || d.class === cFilter)
            );
        }

        function initCharts() {
            Chart.defaults.font.family = "'å¾®è»Ÿæ­£é»‘é«”', sans-serif";
            
            trendChart = new Chart(document.getElementById('trendChart'), {
                type: 'bar', data: { labels: [], datasets: [] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'äº‹æ•…ç™¼ç”Ÿè¶¨å‹¢' } }, scales: { x: { stacked: true }, y: { stacked: true } } }
            });

            operatorPieChart = new Chart(document.getElementById('operatorPieChart'), {
                type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'ç‡Ÿé‹æ©Ÿæ§‹ä½”æ¯”' } } }
            });

            classPieChart = new Chart(document.getElementById('classPieChart'), {
                type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'åˆ†é¡ä½”æ¯” (é‡å¤§/ä¸€èˆ¬/ç•°å¸¸)' } } }
            });

            typeChart = new Chart(document.getElementById('typeChart'), {
                type: 'bar', data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y', 
                    plugins: { title: { display: false }, legend: { display: false } },
                    onClick: (e, activeElements) => {
                        if (activeElements.length > 0) {
                            const clickedType = typeChart.data.labels[activeElements[0].index];
                            selectedTypeFilter = (selectedTypeFilter === clickedType) ? null : clickedType;
                            currentDrillLevel = 1; selectedL1 = null; selectedL2 = null; selectedL3 = null;
                            updateAllCharts(); 
                        }
                    }
                }
            });

            causeChart = new Chart(document.getElementById('causeChart'), {
                type: 'bar', data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y', 
                    plugins: { title: { display: false }, legend: { display: false } },
                    onClick: (e, activeElements) => {
                        if (activeElements.length > 0) { drillDown(causeChart.data.labels[activeElements[0].index]); }
                    }
                }
            });
        }

        function resetDashboard() {
            document.getElementById('operatorFilter').value = 'all';
            document.getElementById('timeAggFilter').value = 'month';
            document.getElementById('monthFilter').value = 'all';
            document.getElementById('classFilter').value = 'all';

            selectedTypeFilter = null;
            currentDrillLevel = 1;
            selectedL1 = null;
            selectedL2 = null;
            selectedL3 = null;

            updateAllCharts();
        }

        function updateAllCharts() {
            const baseData = getBaseData();
            const timeAgg = document.getElementById('timeAggFilter').value;
            let timeLabels = timeAgg === 'month' ? months : quarters;
            let timeField = timeAgg === 'month' ? 'month' : 'quarter';

            let topData = baseData;
            if (selectedTypeFilter) topData = topData.filter(d => d.type === selectedTypeFilter);
            if (selectedL1) topData = topData.filter(d => d.l1 === selectedL1);
            if (selectedL2) topData = topData.filter(d => d.l2 === selectedL2);
            if (selectedL3) topData = topData.filter(d => d.l3 === selectedL3);

            const trendData = { 'é‡å¤§è¡Œè»Šäº‹æ•…': {}, 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…': {}, 'ç•°å¸¸äº‹ä»¶': {} };
            timeLabels.forEach(t => { trendData['é‡å¤§è¡Œè»Šäº‹æ•…'][t] = 0; trendData['ä¸€èˆ¬è¡Œè»Šäº‹æ•…'][t] = 0; trendData['ç•°å¸¸äº‹ä»¶'][t] = 0; });
            topData.forEach(d => { if(trendData[d.class][d[timeField]] !== undefined) trendData[d.class][d[timeField]] += d.count; });
            
            trendChart.data.labels = timeLabels;
            trendChart.data.datasets = [
                { label: 'é‡å¤§è¡Œè»Šäº‹æ•…', data: timeLabels.map(t => trendData['é‡å¤§è¡Œè»Šäº‹æ•…'][t]), backgroundColor: CLASS_COLORS['é‡å¤§è¡Œè»Šäº‹æ•…'] },
                { label: 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…', data: timeLabels.map(t => trendData['ä¸€èˆ¬è¡Œè»Šäº‹æ•…'][t]), backgroundColor: CLASS_COLORS['ä¸€èˆ¬è¡Œè»Šäº‹æ•…'] },
                { label: 'ç•°å¸¸äº‹ä»¶', data: timeLabels.map(t => trendData['ç•°å¸¸äº‹ä»¶'][t]), backgroundColor: CLASS_COLORS['ç•°å¸¸äº‹ä»¶'] }
            ];
            trendChart.options.plugins.title.text = timeAgg === 'month' ? 'æ¯æœˆäº‹æ•…ç™¼ç”Ÿè¶¨å‹¢' : 'æ¯å­£äº‹æ•…ç™¼ç”Ÿè¶¨å‹¢';
            trendChart.update();

            // â˜… åš´æ ¼é–å®šç‡Ÿé‹æ©Ÿæ§‹æ’åºï¼šè‡ºéµã€é«˜éµã€æ—éµã€ç³–éµ
            const opData = topData.reduce((acc, curr) => { acc[curr.operator] = (acc[curr.operator] || 0) + curr.count; return acc; }, {});
            const opOrder = ['è‡ºéµ', 'é«˜éµ', 'æ—éµ', 'ç³–éµ'];
            const opLabels = opOrder.filter(op => opData[op]); // ç¢ºä¿æŒ‰ç…§ opOrder çš„é †åºä¸”æœ‰è³‡æ–™æ‰é¡¯ç¤º
            
            operatorPieChart.data.labels = opLabels; 
            operatorPieChart.data.datasets[0].data = opLabels.map(op => opData[op]);
            operatorPieChart.data.datasets[0].backgroundColor = opLabels.map(op => OPERATOR_COLORS[op]);
            operatorPieChart.update();

            // â˜… åš´æ ¼é–å®šåˆ†é¡æ’åºï¼šé‡å¤§è¡Œè»Šäº‹æ•…ã€ä¸€èˆ¬è¡Œè»Šäº‹æ•…ã€ç•°å¸¸äº‹ä»¶
            const classData = topData.reduce((acc, curr) => { acc[curr.class] = (acc[curr.class] || 0) + curr.count; return acc; }, {});
            const classOrder = ['é‡å¤§è¡Œè»Šäº‹æ•…', 'ä¸€èˆ¬è¡Œè»Šäº‹æ•…', 'ç•°å¸¸äº‹ä»¶'];
            const classLabels = classOrder.filter(cls => classData[cls]); // ç¢ºä¿æŒ‰ç…§ classOrder çš„é †åºä¸”æœ‰è³‡æ–™æ‰é¡¯ç¤º
            
            classPieChart.data.labels = classLabels; 
            classPieChart.data.datasets[0].data = classLabels.map(cls => classData[cls]);
            classPieChart.data.datasets[0].backgroundColor = classLabels.map(cls => CLASS_COLORS[cls]);
            classPieChart.update();

            let tData = baseData;
            if (selectedL1) tData = tData.filter(d => d.l1 === selectedL1);
            if (selectedL2) tData = tData.filter(d => d.l2 === selectedL2);
            if (selectedL3) tData = tData.filter(d => d.l3 === selectedL3);

            const typeDataMap = tData.reduce((acc, curr) => { acc[curr.type] = (acc[curr.type] || 0) + curr.count; return acc; }, {});
            const sortedTypes = Object.keys(typeDataMap).sort((a, b) => typeDataMap[b] - typeDataMap[a]);
            typeChart.data.labels = sortedTypes;
            typeChart.data.datasets[0].data = sortedTypes.map(t => typeDataMap[t]);
            
            typeChart.data.datasets[0].backgroundColor = sortedTypes.map(label => {
                const parentClass = typeToClassMap[label]; 
                const baseColor = CLASS_COLORS[parentClass]; 
                
                if (selectedTypeFilter === null) {
                    return baseColor; 
                } else if (selectedTypeFilter === label) {
                    return baseColor; 
                } else {
                    return FADE_COLOR; 
                }
            });
            typeChart.update();

            let cData = baseData;
            if (selectedTypeFilter) cData = cData.filter(d => d.type === selectedTypeFilter);

            let aggregatedData = {};
            let breadcrumbText = "";
            if (selectedTypeFilter) breadcrumbText += `(å·²ç¯©é¸ç¨®é¡ï¼š${selectedTypeFilter}) `;

            if (currentDrillLevel === 1) {
                document.getElementById('btnBack').style.display = 'none';
                breadcrumbText += "ğŸ” è‚‡å› é‘½ç ”ï¼šåŸå› ä¸€éš";
                cData.forEach(d => { aggregatedData[d.l1] = (aggregatedData[d.l1] || 0) + d.count; });
            } else if (currentDrillLevel === 2) {
                document.getElementById('btnBack').style.display = 'block';
                breadcrumbText += `ğŸ” è‚‡å› é‘½ç ”ï¼šåŸå› äºŒéš [éš¸å±¬ ${selectedL1}]`;
                cData.filter(d => d.l1 === selectedL1).forEach(d => { aggregatedData[d.l2] = (aggregatedData[d.l2] || 0) + d.count; });
            } else if (currentDrillLevel === 3) {
                document.getElementById('btnBack').style.display = 'block';
                breadcrumbText += `ğŸ” è‚‡å› é‘½ç ”ï¼šåŸå› ä¸‰éš [éš¸å±¬ ${selectedL2}]`;
                cData.filter(d => d.l1 === selectedL1 && d.l2 === selectedL2).forEach(d => { aggregatedData[d.l3] = (aggregatedData[d.l3] || 0) + d.count; });
            }

            const sortedKeys = Object.keys(aggregatedData).sort((a, b) => aggregatedData[b] - aggregatedData[a]);
            causeChart.data.labels = sortedKeys;
            causeChart.data.datasets[0].data = sortedKeys.map(k => aggregatedData[k]);
            
            if (currentDrillLevel === 1) {
                causeChart.data.datasets[0].backgroundColor = sortedKeys.map(() => DEPTH_COLORS[1]);
            } else if (currentDrillLevel === 2) {
                causeChart.data.datasets[0].backgroundColor = sortedKeys.map(() => DEPTH_COLORS[2]);
            } else if (currentDrillLevel === 3) {
                causeChart.data.datasets[0].backgroundColor = sortedKeys.map(k => 
                    (selectedL3 === null || selectedL3 === k) ? (selectedL3 === k ? FOCUS_COLOR : DEPTH_COLORS[3]) : FADE_COLOR
                );
            }
            causeChart.update();
            
            document.getElementById('causeBreadcrumb').innerText = breadcrumbText;
            document.getElementById('dataSummary').innerText = `ğŸ“Š ç›®å‰æ¢ä»¶ç¬¦åˆå…± ${topData.length} ç­†ç´€éŒ„ (ç´¯è¨ˆ ${topData.reduce((sum, d) => sum + d.count, 0)} ä»¶)`;
        }

        function drillDown(label) {
            if (currentDrillLevel === 1) { 
                selectedL1 = label; currentDrillLevel = 2; 
            } else if (currentDrillLevel === 2) { 
                selectedL2 = label; currentDrillLevel = 3; 
            } else if (currentDrillLevel === 3) {
                selectedL3 = (selectedL3 === label) ? null : label;
            }
            updateAllCharts();
        }

        function goBackLevel() {
            if (currentDrillLevel === 3) { 
                if (selectedL3 !== null) {
                    selectedL3 = null; 
                } else {
                    currentDrillLevel = 2; selectedL2 = null; 
                }
            } else if (currentDrillLevel === 2) { 
                currentDrillLevel = 1; selectedL1 = null; 
            }
            updateAllCharts();
        }
    </script>
</body>
</html>